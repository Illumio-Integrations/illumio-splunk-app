<form version="1.1">
  <label>Workload Operations</label>
  <search id="workload_lookup_base_search">
    <query>
      | inputlookup illumio_workloads_lookup WHERE pce_fqdn=$pce_tok|s$ org_id=$org_id_tok|s$ deleted=0
    </query>
    <earliest>1</earliest>
    <latest>now</latest>
  </search>
  <search id="audit_base_search">
    <query>
      | tstats `summariesonly` values(Audit.src_user) AS src_user, values(Audit.user) AS user, values(Audit.src_ip) AS src_ip, values(Audit.notification_type) AS notification_type, values(Audit.severity) AS severity, values(Audit.status) AS status, values(Audit.pce_fqdn) AS pce_fqdn, values(Audit.event_type) AS event_type, values(Audit.object_id) AS object_id FROM datamodel=Illumio.Audit WHERE Audit.pce_fqdn=$pce_tok|s$ Audit.org_id=$org_id_tok|s$ BY _time Audit.href
    </query>
    <earliest>$time_range.earliest$</earliest>
    <latest>$time_range.latest$</latest>
  </search>
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_range">
    <label>Time Range</label>
    <default>
      <earliest>-60m@m</earliest>
      <latest>now</latest>
    </default>
    </input>
    <input type="dropdown" token="pce_tok">
      <label>PCE</label>
      <search>
        <query>| inputlookup illumio_workloads_lookup | stats count BY pce_fqdn</query>
        <earliest>1</earliest>
        <latest>now</latest>
      </search>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>pce_fqdn</fieldForLabel>
      <fieldForValue>pce_fqdn</fieldForValue>
      <change>
        <unset token="form.os_id"></unset>
        <unset token="form.agent_event_type"></unset>
        <unset token="form.workload_event_type"></unset>
      </change>
    </input>
    <input type="dropdown" token="org_id_tok">
      <label>Org ID</label>
      <search>
        <query>| inputlookup illumio_workloads_lookup WHERE pce_fqdn=$pce_tok|s$ | stats count BY org_id</query>
        <earliest>1</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>org_id</fieldForLabel>
      <fieldForValue>org_id</fieldForValue>
      <choice value="*">All</choice>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Managed Workloads</title>
      <single>
        <search base="workload_lookup_base_search">
          <query>
            | search managed=1
            | stats dc(href) AS "Managed Workloads"
          </query>
        </search>
        <option name="drilldown">all</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20managed%3D1%20pce_fqdn=$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>Unmanaged Workloads</title>
      <single>
        <search base="workload_lookup_base_search">
          <query>
            | search managed=0
            | stats dc(href) AS "Unmanaged Workloads"
          </query>
        </search>
        <option name="drilldown">all</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20managed%3D0%20pce_fqdn=$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0</link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Managed Workloads by Version</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | search managed=1
            | chart dc(href) AS "VEN Count" BY ven.version
            | rename ven.version AS "Version"
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20managed%3D1%20ven.version%3D$click.value$%20pce_fqdn=$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0</link>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <title>Managed Workloads by Enforcement Mode</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | search managed=1
            | chart dc(href) AS "VEN Count" BY enforcement_mode
            | rename enforcement_mode AS "Enforcement Mode"
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.fieldColors">{Count:0x70c580}</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20managed%3D1%20enforcement_mode%3D$click.value$%20pce_fqdn=$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0</link>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <title>Managed Workloads by Operating System</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | search managed=1
            | fillnull value="Unknown" os_id
            | chart dc(href) AS "VEN Count" BY os_id
            | rename os_id AS "OS"
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20managed%3D1%20os_id%3D$click.value$%20pce_fqdn=$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>VEN Timeouts</title>
      <single>
        <search base="audit_base_search">
          <query>
            | search event_type="system_task.agent_offline_check"
            | stats dc(object_id) AS "Timed Out"
          </query>
        </search>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x333","0xd93f3c"]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
        <drilldown>
          <link target="_blank">search?q=| tstats `summariesonly` values(Audit.event_type) as event_type, values(Audit.pce_fqdn) as pce_fqdn, values(Audit.href) as href from datamodel=Illumio.Audit WHERE Audit.pce_fqdn=$pce_tok|s$ Audit.org_id=$org_id_tok|s$ BY Audit.timestamp Audit.event_type | search event_type="system_task.agent_offline_check" | rename Audit.timestamp as Time, href as HREF, hostname as "Host Name" | table Time HREF "Host Name"&amp;earliest=$time_range.earliest$&amp;latest=$time_range.latest$&amp;auto_pause=$auto_pause$</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>VEN Event Count By Status</title>
      <chart>
        <search base="audit_base_search">
          <query>
            | search event_type="system_task.agent_offline_check" OR event_type="workload.online"
            | eval workload_state = if(event_type="workload.online", "Online", "Offline")
            | timechart dc(object_id) BY workload_state
            | append
                [| search `illumio_get_index` sourcetype="illumio:pce" pce_fqdn=$pce_tok|s$ org_id=$org_id_tok|s$ event_type="system_task.agent_missed_heartbeats_check"
                | eval ven_href='notifications{}.info.ven.href'
                | timechart dc(ven_href) AS "Missed Heartbeat"]
          </query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=| tstats `summariesonly` values(Audit.event_type) as event_type, values(Audit.pce_fqdn) as pce_fqdn, values(Audit.href) as href, values(Audit.created_hostname) as created_hostname, values(Audit.severity) as severity, values(Audit.status) as Status from datamodel=Illumio.Audit WHERE Audit.pce_fqdn=$pce_tok|s$ Audit.org_id=$org_id_tok|s$ BY Audit.timestamp | eval event_type_value=case("$click.name2$"=="Online","workload.online","$click.name2$"=="Offline","system_task.agent_offline_check" ,"$click.name2$"=="Missed Heartbeat","system_task.agent_missed_heartbeats_check") | where event_type=event_type_value | dedup href | fillnull value="-" created_hostname severity status workload_href | table pce_fqdn created_hostname severity status workload_href | rename pce_fqdn as PCE created_hostname as "Host Name" severity as Severity status as Status workload_href as "Workload Href"&amp;earliest=$time_range.earliest$&amp;latest=$time_range.latest$</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Agent Event Count by Event Type</title>
      <input type="dropdown" token="agent_event_type">
        <label>Event Type</label>
        <fieldForLabel>event_type</fieldForLabel>
        <fieldForValue>event_type</fieldForValue>
        <search base="audit_base_search">
          <query>
            | search event_type="agent.*"
            | stats count BY event_type
          </query>
        </search>
        <choice value="agent.*">All</choice>
        <default>agent.*</default>
        <initialValue>agent.*</initialValue>
        <prefix>event_type="</prefix>
        <suffix>"</suffix>
      </input>
      <chart>
        <search base="audit_base_search">
          <query>
            | search $agent_event_type$
            | timechart limit=0 count BY event_type
          </query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">VEN Count</option>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20tstats%20%60summariesonly%60%20values(Audit.event_type)%20as%20event_type%2C%20values(Audit.pce_fqdn)%20as%20pce_fqdn%2C%20values(Audit.severity)%20as%20severity%2C%20values(Audit.status)%20as%20status%2C%20values(Audit.category)%20as%20category%20from%20datamodel%3DIllumio.Audit%20WHERE%20Audit.pce_fqdn%3D$pce_tok|s$%20Audit.org_id=$org_id_tok|s$%20BY%20Audit.timestamp%20%0A%7C%20search%20event_type%3D%22$click.name2$%22%20%0A%7C%20table%20pce_fqdn%20category%20severity%20status%20event_type%20%0A%7C%20fillnull%20value%3D%22-%22%0A%7C%20rename%20pce_fqdn%20as%20PCE%2C%20category%20as%20Category%2C%20severity%20as%20Severity%2C%20status%20as%20Status%2C%20event_type%20as%20%22Event%20Type%22&amp;earliest=$time_range.earliest$&amp;latest=$time_range.latest$</link>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <title>Workload Event Count by Event Type</title>
      <input type="dropdown" token="workload_event_type">
        <label>Event Type</label>
        <fieldForLabel>event_type</fieldForLabel>
        <fieldForValue>event_type</fieldForValue>
        <search base="audit_base_search">
          <query>
            | search (event_type="workload.*" OR event_type="workloads.*")
            | stats count BY event_type
          </query>
        </search>
        <choice value="workload.* OR event_type=workloads.*">All</choice>
        <prefix>(event_type=</prefix>
        <suffix>)</suffix>
        <default>workload.* OR event_type=workloads.*</default>
        <initialValue>workload.* OR event_type=workloads.*</initialValue>
      </input>
      <chart>
        <search base="audit_base_search">
          <query>
            | search $workload_event_type$
            | timechart limit=0 count by event_type
          </query>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">VEN Count</option>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20tstats%20%60summariesonly%60%20values(Audit.event_type)%20as%20event_type%2C%20values(Audit.pce_fqdn)%20as%20pce_fqdn%2C%20values(Audit.severity)%20as%20severity%2C%20values(Audit.status)%20as%20status%2C%20values(Audit.category)%20as%20category%20FROM%20datamodel%3DIllumio.Audit%20WHERE%20Audit.pce_fqdn%3D$pce_tok|s$%20Audit.org_id=$org_id_tok|s$%20BY%20Audit.timestamp%20%0A%7C%20search%20event_type%3D%22$click.name2$%22%20%0A%7C%20table%20pce_fqdn%20category%20severity%20status%20event_type%20%0A%7C%20fillnull%20value%3D%22-%22%0A%7C%20rename%20pce_fqdn%20as%20PCE%2C%20category%20as%20Category%2C%20severity%20as%20Severity%2C%20status%20as%20Status%2C%20event_type%20as%20%22Event%20Type%22&amp;earliest=$time_range.earliest$&amp;latest=$time_range.latest$</link>
        </drilldown>
      </chart>
    </panel>
  </row>
</form>