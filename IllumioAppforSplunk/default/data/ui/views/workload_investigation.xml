<form version="1.1">
  <label>Workload Investigations</label>
  <search id="workload_lookup_base_search">
    <query>
      | inputlookup illumio_workloads_lookup WHERE pce_fqdn=$pce_tok|s$ org_id=$org_id_tok|s$ deleted=0 (hostname=$host_ip|s$ OR public_ip=$host_ip|s$)
      | where $label_filter$
    </query>
    <earliest>1</earliest>
    <latest>now</latest>
  </search>
  <fieldset submitButton="true" autoRun="true">
    <input type="dropdown" token="pce_tok">
      <label>PCE</label>
      <search>
        <query>| inputlookup illumio_workloads_lookup | stats count BY pce_fqdn</query>
        <earliest>1</earliest>
        <latest>now</latest>
      </search>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>pce_fqdn</fieldForLabel>
      <fieldForValue>pce_fqdn</fieldForValue>
    </input>
    <input type="dropdown" token="org_id_tok">
      <label>Org ID</label>
      <search>
        <query>| inputlookup illumio_workloads_lookup WHERE pce_fqdn=$pce_tok|s$ | stats count BY org_id</query>
        <earliest>1</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>org_id</fieldForLabel>
      <fieldForValue>org_id</fieldForValue>
      <choice value="*">All</choice>
      <default>*</default>
    </input>
    <input type="text" token="host_ip">
      <label>Hostname/IP</label>
      <default>*</default>
      <initialValue>*</initialValue>
    </input>
    <input type="multiselect" token="label_filter">
      <label>Labels</label>
      <fieldForLabel>label</fieldForLabel>
      <fieldForValue>href</fieldForValue>
      <choice value=".*">All</choice>
      <default>.*</default>
      <valuePrefix>isnotnull(mvfind('labels', "</valuePrefix>
      <valueSuffix>"))</valueSuffix>
      <delimiter> AND </delimiter>
      <prefix>(</prefix>
      <suffix>)</suffix>
      <search>
        <query>| inputlookup illumio_labels_lookup WHERE pce_fqdn=$pce_tok|s$ org_id=$org_id_tok|s$ deleted=0 | eval label = key + ":" + value | table href label</query>
        <earliest>1</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
        <div style="font-size:13px; font-style:italic">Please specify either hostname(s) or scope labels. If both hostname and scope labels are specified, then the filter uses AND condition.</div>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>VENs by Status</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | search agent.status.status=*
            | rename agent.status.status AS Status
            | stats count BY Status
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">none</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20agent.status.status%3D$click.value$%20pce_fqdn%3D$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0%20(hostname%3D$host_ip|s$%20OR%20public_ip%3D$host_ip|s$)%0A%7C%20where%20$label_filter$&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <title>Policy Enforcement Mode</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | rename enforcement_mode AS "Enforcement Mode"
            | stats count BY "Enforcement Mode"
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">none</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20enforcement_mode%3D$click.value$%20pce_fqdn%3D$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0%20(hostname%3D$host_ip|s$%20OR%20public_ip%3D$host_ip|s$)%0A%7C%20where%20$label_filter$&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <title>Policy Synchronization Status</title>
      <chart>
        <search base="workload_lookup_base_search">
          <query>
            | fillnull value="unknown" agent.status.security_policy_sync_state
            | rename agent.status.security_policy_sync_state AS "Policy Sync State"
            | stats count BY "Policy Sync State"
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">none</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20agent.status.security_policy_sync_state%3D$click.value$%20pce_fqdn%3D$pce_tok|s$%20org_id=$org_id_tok|s$%20deleted%3D0%20(hostname%3D$host_ip|s$%20OR%20public_ip%3D$host_ip|s$)%0A%7C%20where%20$label_filter$&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Workload Details</title>
      <table>
        <search base="workload_lookup_base_search">
          <query>
            | rename labels.href AS label_href
            | mvexpand label_href
            | lookup illumio_labels_lookup pce_fqdn href AS label_href OUTPUT key AS label_key value AS label_value
            | eval Workload = if(isnull(name), hostname, name)
            | eval OS = os_id + " - " + os_detail
            | eval Online = if(online = 1, "online", "offline")
            | eval "Updated at" = strftime(strptime(updated_at, "%Y-%m-%dT%H:%M:%S.%6NZ"), "%+")
            | eval "Policy Applied at" = if(isnull('agent.status.security_policy_applied_at'), "No policy applied", strftime(strptime('agent.status.security_policy_applied_at', "%Y-%m-%dT%H:%M:%S.%6NZ"), "%+"))
            | eval Labels = mvzip(label_key, label_value, ":")
            | stats values AS * BY href
            | eval PCE = if(isnotnull('agent.active_pce_fqdn'), 'agent.active_pce_fqdn', pce_fqdn)
            | rename interfaces.name AS Interfaces, interfaces.address AS IPs, ven.status AS Status, ven.ven_type AS "VEN Type", enforcement_mode AS "Enforcement Mode", agent.status.security_policy_sync_state AS "Policy Sync State"
            | table href Workload PCE Online Status "Enforcement Mode" Labels OS Interfaces IPs "VEN Type" "Policy Sync State" "Policy Applied at" "Updated at"
            | sort - "Updated at"
          </query>
        </search>
        <fields>Workload PCE Online Status "Enforcement Mode" Labels OS Interfaces IPs "VEN Type" "Policy Sync State" "Policy Applied at" "Updated at"</fields>
        <option name="count">5</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">true</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20illumio_workloads_lookup%20WHERE%20href%3D$row.href|s$&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
</form>